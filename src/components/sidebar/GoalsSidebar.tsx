"use client"

import { SidebarContainer } from "./SidebarContainer";
import { CreateTaskButton } from "../button/CreateTaskButton";
import { GoalSidebarTask } from "../goals/GoalSidebarTask";
import { DatePicker } from "../goals/DatePicker";
import { Trash } from "lucide-react";

import { GoalType } from "@/src/types/goal";
import { Text, Stack, Button, Icon, Progress, Span } from "@chakra-ui/react";

import { styles } from "@/styles/sidebar/goalsSidebar.styles";
import scrollbarStyles from "@/styles/sidebar/scroll.module.css";

import { useGoalsSidebar } from "@/src/hooks/goalClient/useGoalsSidebar";

interface Props {
  closeSidebar: () => void;
  goal: GoalType;
  updateCheckedTask: (taskId: string, isChecked: boolean) => void;
  refreshGoal: (taskId: string, action: string) => void;
  updateDeadlineState: (goalId: string, newDeadline: string) => void;
  isSidebarOpen?: boolean;
}

export function GoalsSidebar({
  closeSidebar,
  goal,
  updateCheckedTask,
  refreshGoal,
  updateDeadlineState,
  isSidebarOpen
}: Props) {

  const {
    goalTasks,
    handleCheckedTask,
    updateDeletedTask,
    handleAddTask,
    handleDeleteGoal,
    allTasks,
    checkedTasks,
  } = useGoalsSidebar({
    closeSidebar,
    goal,
    updateCheckedTask,
  });

  return (
    <SidebarContainer
      header={goal.title}
      closeSidebar={closeSidebar}
      isSidebarOpen={isSidebarOpen}
    >
      <Stack {...styles.container}>

        <DatePicker
          goalId={goal.id}
          updateDeadlineState={updateDeadlineState}
        />

        <Stack>
          <Text {...styles.statusText}>Em andamento</Text>

          <Stack {...styles.tasksStack} className={scrollbarStyles["scrollbar"]}>
            {(goalTasks.filter((task) => !task.isChecked).map(
              (task) => (
                <GoalSidebarTask
                  key={task.id}
                  task={task}
                  updateDeletedTask={updateDeletedTask}
                  updateCheckedTask={handleCheckedTask}
                  refreshGoal={refreshGoal}
                />
              )
            ))}
          </Stack>

          <Stack {...styles.createTaskStack}>
            <CreateTaskButton
              goalId={goal.id}
              updateAddedTask={handleAddTask}
              refreshGoal={refreshGoal}
            />
          </Stack>
        </Stack>

        <Stack>
          <Text {...styles.statusText}>Concluídas</Text>

          <Stack {...styles.tasksStack} className={scrollbarStyles["scrollbar"]}>
            {(goalTasks.filter((task) => task.isChecked).map((task) => (
              <GoalSidebarTask
                key={task.id}
                task={task}
                updateDeletedTask={updateDeletedTask}
                updateCheckedTask={handleCheckedTask}
                refreshGoal={refreshGoal}
              />
            )))}
          </Stack>
        </Stack>

        <Stack {...styles.progressContainer}>
          <Text {...styles.statusText}>Progresso</Text>

          <Text
            {...styles.progressIndicator}
            {...((checkedTasks / allTasks) === 1 && styles.progressIndicatorCompleted)}
          >
            {checkedTasks} de {allTasks}
          </Text>

          <Progress.Root value={(checkedTasks / allTasks) * 100}>
            <Progress.Track {...styles.progressBar.track}>
              <Progress.Range
                {...styles.progressBar.range}
                {...((checkedTasks / allTasks) === 1 && styles.progressBar.completed)}
              >
                <Text>
                  {goalTasks.length > 0 && (Math.round((checkedTasks / allTasks) * 100) || 0)}
                  {goalTasks.length > 0 && "%"}
                </Text>
              </Progress.Range>
            </Progress.Track>
          </Progress.Root>

          <Text {...styles.statusIndicator}>
            Status:{" "}
            <Span
              {...(checkedTasks / allTasks === 1
                ? styles.progressIndicatorCompleted
                : styles.statusIndicatorInProgress)}
            >
              {(checkedTasks / allTasks === 1 ? "concluído" : "em andamento")}
            </Span>
          </Text>
        </Stack>

        <Button {...styles.deleteButton} onClick={handleDeleteGoal}>
          <Icon size="sm">
            <Trash />
          </Icon>
          Excluir meta
        </Button>

      </Stack>
    </SidebarContainer>
  );
}
